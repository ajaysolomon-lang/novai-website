<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novai Admin — Leads &amp; Analytics</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#050a12;--surface:#0d1117;--surface2:#161b22;--border:rgba(255,255,255,.08);--text:#e6edf3;--dim:rgba(255,255,255,.5);--accent:#0077ff;--accent2:#00bbff;--green:#00c853;--red:#ff3b3b;--orange:#ff9800}
    body{background:var(--bg);color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh}
    a{color:var(--accent);text-decoration:none}

    /* Header */
    .admin-header{padding:20px 32px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .admin-header h1{font-size:18px;font-weight:700}
    .admin-header h1 span{color:var(--accent)}
    .admin-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .admin-actions button{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;cursor:pointer;transition:all .15s;font-family:inherit}
    .admin-actions button:hover{border-color:var(--accent);background:rgba(0,119,255,.1)}
    .admin-actions button.danger{border-color:rgba(255,59,59,.3)}
    .admin-actions button.danger:hover{border-color:var(--red);background:rgba(255,59,59,.1)}

    /* Status bar */
    .status-bar{padding:10px 32px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;flex-wrap:wrap;font-size:12px}
    .status-item{display:flex;align-items:center;gap:6px}
    .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .status-dot.green{background:var(--green);box-shadow:0 0 6px rgba(0,200,83,.5)}
    .status-dot.red{background:var(--red);box-shadow:0 0 6px rgba(255,59,59,.5)}
    .status-dot.orange{background:var(--orange);box-shadow:0 0 6px rgba(255,152,0,.5)}
    .status-dot.blue{background:var(--accent);box-shadow:0 0 6px rgba(0,119,255,.5)}
    .status-dot.pulsing{animation:statusPulse 1.5s ease-in-out infinite}
    @keyframes statusPulse{0%,100%{opacity:1}50%{opacity:.4}}
    .status-label{color:var(--dim)}
    .status-value{color:var(--text);font-weight:600}
    .source-badge{font-size:11px;padding:3px 10px;border-radius:20px;background:rgba(0,119,255,.1);color:var(--accent2);border:1px solid rgba(0,119,255,.2)}
    .auto-refresh-toggle{display:flex;align-items:center;gap:6px;margin-left:auto;cursor:pointer;color:var(--dim);user-select:none}
    .auto-refresh-toggle input{accent-color:var(--accent)}
    .auto-refresh-toggle:hover{color:var(--text)}

    /* Stats bar */
    .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;padding:24px 32px}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px 24px}
    .stat-card .label{font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
    .stat-card .value{font-size:28px;font-weight:700}
    .stat-card .value.green{color:var(--green)}
    .stat-card .value.blue{color:var(--accent)}
    .stat-card .value.orange{color:var(--orange)}
    .stat-card .value.red{color:var(--red)}

    /* Tabs */
    .tabs{display:flex;gap:0;padding:0 32px;border-bottom:1px solid var(--border);overflow-x:auto}
    .tab{padding:12px 24px;font-size:14px;font-weight:600;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab .tab-count{font-size:11px;font-weight:700;margin-left:6px;padding:1px 6px;border-radius:10px;background:rgba(0,119,255,.15);color:var(--accent2)}

    /* Content */
    .content{padding:24px 32px}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* Table */
    .data-table{width:100%;border-collapse:collapse;font-size:13px}
    .data-table th{text-align:left;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);font-weight:600;position:sticky;top:0}
    .data-table td{padding:12px 16px;border-bottom:1px solid var(--border);vertical-align:top}
    .data-table tr:hover td{background:rgba(0,119,255,.03)}
    .data-table .empty{text-align:center;padding:48px;color:var(--dim)}

    /* Badges */
    .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-blue{background:rgba(0,119,255,.15);color:var(--accent2)}
    .badge-green{background:rgba(0,200,83,.15);color:var(--green)}
    .badge-orange{background:rgba(255,152,0,.15);color:var(--orange)}
    .badge-red{background:rgba(255,59,59,.15);color:var(--red)}
    .badge-dim{background:rgba(255,255,255,.05);color:var(--dim)}

    /* Log entries */
    .log-entry{padding:12px 16px;border-bottom:1px solid var(--border);font-family:'SF Mono',SFMono-Regular,Consolas,monospace;font-size:12px;line-height:1.6}
    .log-entry .timestamp{color:var(--dim);margin-right:12px}
    .log-entry .event{color:var(--green)}
    .log-entry .event-call{color:var(--orange)}
    .log-entry .event-report{color:var(--accent2)}
    .log-entry .event-callback{color:#bb86fc}
    .log-entry .data{color:var(--accent2)}

    /* Export area */
    .export-area{margin-top:16px}
    .export-area textarea{width:100%;height:200px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:16px;font-family:'SF Mono',SFMono-Regular,Consolas,monospace;font-size:12px;resize:vertical}

    /* Diagnostics */
    .diag-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}
    .diag-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px}
    .diag-card h4{font-size:13px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
    .diag-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
    .diag-row:last-child{border-bottom:none}
    .diag-row .diag-label{color:var(--dim)}
    .diag-row .diag-value{font-weight:600;font-family:'SF Mono',SFMono-Regular,Consolas,monospace}
    .diag-row .diag-value.ok{color:var(--green)}
    .diag-row .diag-value.warn{color:var(--orange)}
    .diag-row .diag-value.error{color:var(--red)}
    .kv-keys-list{margin-top:12px;max-height:200px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:12px;font-family:'SF Mono',SFMono-Regular,Consolas,monospace;font-size:11px;color:var(--dim);line-height:1.8}
    .kv-keys-list .key{color:var(--accent2)}

    /* Call report detail */
    .report-summary{font-size:12px;color:var(--dim);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .report-expand{font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline}

    /* Responsive */
    @media(max-width:768px){
      .stats-bar{grid-template-columns:repeat(2,1fr);padding:16px}
      .content,.tabs{padding-left:16px;padding-right:16px}
      .admin-header,.status-bar{padding-left:16px;padding-right:16px}
      .data-table{font-size:12px}
      .data-table th,.data-table td{padding:8px 10px}
      .diag-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <div class="admin-header">
    <div style="display:flex;align-items:center;gap:12px">
      <h1>NOVAI <span>ADMIN</span></h1>
    </div>
    <div class="admin-actions">
      <button onclick="refreshData()">Refresh</button>
      <button onclick="exportCSV()">Export CSV</button>
      <button onclick="exportJSON()">Export JSON</button>
      <button class="danger" onclick="clearData()">Clear All</button>
    </div>
  </div>

  <div class="status-bar" id="status-bar">
    <div class="status-item">
      <span class="status-dot orange" id="api-status-dot"></span>
      <span class="status-label">API:</span>
      <span class="status-value" id="api-status-text">Connecting...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Source:</span>
      <span class="source-badge" id="data-source">—</span>
    </div>
    <div class="status-item">
      <span class="status-label">Last refresh:</span>
      <span class="status-value" id="last-refresh">—</span>
    </div>
    <div class="status-item">
      <span class="status-label">Records:</span>
      <span class="status-value" id="record-count">—</span>
    </div>
    <label class="auto-refresh-toggle">
      <input type="checkbox" id="auto-refresh-check" checked>
      <span>Auto-refresh (30s)</span>
    </label>
  </div>

  <div class="stats-bar" id="stats-bar"></div>

  <div class="tabs">
    <div class="tab active" data-tab="leads">Leads <span class="tab-count" id="count-leads">0</span></div>
    <div class="tab" data-tab="analytics">Analytics</div>
    <div class="tab" data-tab="outbound">Outbound Calls <span class="tab-count" id="count-outbound">0</span></div>
    <div class="tab" data-tab="reports">Call Reports <span class="tab-count" id="count-reports">0</span></div>
    <div class="tab" data-tab="callbacks">Callbacks <span class="tab-count" id="count-callbacks">0</span></div>
    <div class="tab" data-tab="logs">Activity Log</div>
    <div class="tab" data-tab="diagnostics">Diagnostics</div>
    <div class="tab" data-tab="export">Export</div>
  </div>

  <div class="content">
    <!-- Leads Table -->
    <div class="tab-panel active" id="panel-leads">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Product</th>
            <th>Source</th>
            <th>Need</th>
            <th>Outbound</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="leads-body"></tbody>
      </table>
    </div>

    <!-- Analytics -->
    <div class="tab-panel" id="panel-analytics">
      <h3 style="font-size:14px;margin-bottom:16px;color:var(--dim)">Leads by Product</h3>
      <div id="product-breakdown"></div>
      <h3 style="font-size:14px;margin:24px 0 16px;color:var(--dim)">Leads by Day</h3>
      <div id="daily-breakdown"></div>
      <h3 style="font-size:14px;margin:24px 0 16px;color:var(--dim)">Leads by Source</h3>
      <div id="source-breakdown"></div>
    </div>

    <!-- Outbound Calls -->
    <div class="tab-panel" id="panel-outbound">
      <p style="margin-bottom:16px;color:var(--dim);font-size:13px">Outbound calls are triggered automatically via Vapi when a lead submits their phone number through the sales agent.</p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Product Interest</th>
            <th>Call Status</th>
            <th>Call ID</th>
            <th>Captured</th>
          </tr>
        </thead>
        <tbody id="outbound-body"></tbody>
      </table>
    </div>

    <!-- Call Reports (from Vapi end-of-call) -->
    <div class="tab-panel" id="panel-reports">
      <p style="margin-bottom:16px;color:var(--dim);font-size:13px">Call data from Vapi AI phone agents. Merges KV webhook reports with live Vapi API data — today's calls always show.</p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Customer</th>
            <th>Duration</th>
            <th>Cost</th>
            <th>Ended</th>
            <th>Summary</th>
            <th>Source</th>
            <th>Call ID</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="reports-body"></tbody>
      </table>
    </div>

    <!-- Callbacks -->
    <div class="tab-panel" id="panel-callbacks">
      <p style="margin-bottom:16px;color:var(--dim);font-size:13px">Callback requests scheduled through the Vapi AI phone agents.</p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Preferred Time</th>
            <th>Reason</th>
            <th>Scheduled At</th>
          </tr>
        </thead>
        <tbody id="callbacks-body"></tbody>
      </table>
    </div>

    <!-- Activity Log -->
    <div class="tab-panel" id="panel-logs">
      <div id="activity-log"></div>
    </div>

    <!-- Diagnostics -->
    <div class="tab-panel" id="panel-diagnostics">
      <div id="diagnostics-content">
        <p style="color:var(--dim)">Loading diagnostics...</p>
      </div>
    </div>

    <!-- Export -->
    <div class="tab-panel" id="panel-export">
      <h3 style="font-size:14px;margin-bottom:12px">Raw JSON Data (All: Leads + Call Reports + Callbacks)</h3>
      <div class="export-area">
        <textarea id="export-json" readonly></textarea>
      </div>
      <h3 style="font-size:14px;margin:24px 0 12px">CSV Data (Leads)</h3>
      <div class="export-area">
        <textarea id="export-csv" readonly></textarea>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // ─── Auth Gate ────────────────────────────────────────
      var ADMIN_KEY = sessionStorage.getItem('novai_admin_key');
      if (!ADMIN_KEY) {
        ADMIN_KEY = prompt('Enter admin API key:');
        if (!ADMIN_KEY) {
          document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#ff3b3b;font-size:18px;font-family:monospace">Access denied — no API key provided.</div>';
          return;
        }
        sessionStorage.setItem('novai_admin_key', ADMIN_KEY);
      }

      var GTM_WORKER_URL = 'https://novai-gtm-outbound.ajay-solomon.workers.dev';
      var AUTH_HEADERS = { 'Authorization': 'Bearer ' + ADMIN_KEY };
      var allLeads = [];
      var allCallReports = [];
      var allCallbacks = [];
      var allVapiCalls = [];
      var dataSource = 'initializing';
      var autoRefreshTimer = null;
      var lastRefreshTime = null;

      // ─── Data Access ───────────────────────────────────────
      function getLocalLeads() {
        try {
          return JSON.parse(localStorage.getItem('novai_leads') || '[]');
        } catch(e) { return []; }
      }

      function fetchWorkerFull() {
        return fetch(GTM_WORKER_URL + '/leads/full', { headers: AUTH_HEADERS })
          .then(function(res) {
            if (res.status === 401 || res.status === 403) {
              sessionStorage.removeItem('novai_admin_key');
              document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#ff3b3b;font-size:18px;font-family:monospace">Invalid API key — <a href="" style="color:#0077ff;margin-left:8px">retry</a></div>';
              return null;
            }
            if (res.status === 404) {
              // /leads/full not deployed yet — fallback to /leads
              return fetchWorkerLeadsFallback();
            }
            return res.json();
          })
          .catch(function() { return null; });
      }

      function fetchWorkerLeadsFallback() {
        return fetch(GTM_WORKER_URL + '/leads', { headers: AUTH_HEADERS })
          .then(function(res) {
            if (res.status === 401 || res.status === 403) return null;
            return res.json().then(function(leads) {
              return { leads: leads, callReports: [], callbacks: [] };
            });
          })
          .catch(function() { return null; });
      }

      function fetchVapiCalls() {
        return fetch(GTM_WORKER_URL + '/calls/vapi?limit=100', { headers: AUTH_HEADERS })
          .then(function(res) {
            if (!res.ok) return [];
            return res.json();
          })
          .then(function(data) {
            // Vapi returns an array of call objects
            if (Array.isArray(data)) return data;
            return [];
          })
          .catch(function() { return []; });
      }

      // Convert Vapi API call objects to our call report format
      function vapiCallToReport(call) {
        return {
          callId: call.id,
          type: call.type,
          phoneNumberId: call.phoneNumberId,
          customerNumber: call.customer ? call.customer.number : '',
          duration: call.endedAt && call.startedAt
            ? Math.round((new Date(call.endedAt) - new Date(call.startedAt)) / 1000)
            : call.costs ? Math.round(call.costs.reduce(function(s, c) { return s + (c.minutes || 0); }, 0) * 60) : null,
          cost: call.cost || (call.costs ? call.costs.reduce(function(s, c) { return s + (c.cost || 0); }, 0) : null),
          endedReason: call.endedReason,
          summary: call.analysis ? call.analysis.summary : (call.summary || ''),
          transcript: call.transcript || call.messages || '',
          timestamp: call.createdAt || call.startedAt || '',
          status: call.status,
          _fromVapi: true,
        };
      }

      // Merge KV reports with Vapi API reports (dedup by callId)
      function mergeCallReports(kvReports, vapiCalls) {
        var seen = {};
        var merged = [];

        // KV reports first (they may have more context from webhook)
        kvReports.forEach(function(r) {
          if (r.callId) seen[r.callId] = true;
          merged.push(r);
        });

        // Add Vapi API calls not already in KV
        vapiCalls.forEach(function(call) {
          var report = vapiCallToReport(call);
          if (!seen[report.callId]) {
            seen[report.callId] = true;
            merged.push(report);
          }
        });

        return merged;
      }

      // Extract leads from Vapi calls that had captureLead tool calls
      function extractLeadsFromVapiCalls(vapiCalls) {
        var leads = [];
        vapiCalls.forEach(function(call) {
          // Check messages for tool calls that captured leads
          if (call.messages && Array.isArray(call.messages)) {
            call.messages.forEach(function(msg) {
              if (msg.role === 'tool_calls' || msg.toolCalls) {
                var toolCalls = msg.toolCalls || [];
                toolCalls.forEach(function(tc) {
                  if (tc.function && tc.function.name === 'captureLead') {
                    try {
                      var args = typeof tc.function.arguments === 'string'
                        ? JSON.parse(tc.function.arguments)
                        : tc.function.arguments;
                      if (args && args.name) {
                        leads.push({
                          name: args.name,
                          email: args.email || '',
                          phone: args.phone || (call.customer ? call.customer.number : ''),
                          need: args.need || '',
                          product: args.product || 'WorkBench',
                          source: call.type === 'outboundPhoneCall' ? 'gtm-outbound-call' : 'inbound-call',
                          timestamp: call.createdAt || call.startedAt || '',
                          callId: call.id,
                          _fromVapi: true,
                        });
                      }
                    } catch(e) {}
                  }
                });
              }
            });
          }
        });
        return leads;
      }

      function mergeLeads(local, remote) {
        var seen = {};
        var merged = [];

        // Remote first — richer data (has outbound call info)
        if (remote && remote.length) {
          remote.forEach(function(l) {
            var key = (l.email || '') + '|' + (l.timestamp || l.id || '');
            if (!seen[key]) {
              seen[key] = true;
              merged.push(l);
            }
          });
        }

        // Add local leads not in remote
        local.forEach(function(l) {
          var key = (l.email || '') + '|' + (l.timestamp || '');
          if (!seen[key]) {
            seen[key] = true;
            merged.push(l);
          }
        });

        return merged;
      }

      async function loadAllData() {
        var local = getLocalLeads();

        // Fetch KV data and live Vapi API data in parallel
        var results = await Promise.all([
          fetchWorkerFull(),
          fetchVapiCalls(),
        ]);
        var remote = results[0];
        var vapiCalls = results[1];
        allVapiCalls = vapiCalls;

        var kvReports = [];
        var kvCallbacks = [];
        var kvLeads = [];
        var vapiOnline = vapiCalls.length > 0;

        if (remote && remote.leads) {
          kvLeads = remote.leads;
          kvReports = remote.callReports || [];
          kvCallbacks = remote.callbacks || [];
        }

        // Merge KV call reports with live Vapi API call data
        allCallReports = mergeCallReports(kvReports, vapiCalls);
        allCallbacks = kvCallbacks;

        // Extract leads from Vapi call tool-calls and merge with KV + local leads
        var vapiLeads = extractLeadsFromVapiCalls(vapiCalls);
        var combinedRemoteLeads = mergeLeads([], kvLeads);
        // Add Vapi-extracted leads (dedup by callId)
        var seenCallIds = {};
        combinedRemoteLeads.forEach(function(l) { if (l.callId) seenCallIds[l.callId] = true; });
        vapiLeads.forEach(function(l) {
          if (l.callId && !seenCallIds[l.callId]) {
            seenCallIds[l.callId] = true;
            combinedRemoteLeads.push(l);
          }
        });
        allLeads = mergeLeads(local, combinedRemoteLeads);

        // Determine data source label
        if (remote !== null && vapiOnline) {
          dataSource = 'Live from Vapi API + KV';
          setAPIStatus('connected', 'Connected');
        } else if (remote !== null) {
          dataSource = 'KV API' + (allLeads.length === 0 ? ' (empty)' : '');
          setAPIStatus('connected', vapiOnline ? 'Connected' : 'Connected (Vapi proxy unavailable)');
        } else if (vapiOnline) {
          dataSource = 'Live from Vapi API (KV offline)';
          setAPIStatus('connected', 'Vapi API only');
        } else {
          allLeads = local;
          dataSource = 'localStorage only (API offline)';
          setAPIStatus('offline', 'Offline');
        }

        lastRefreshTime = new Date();
        document.getElementById('data-source').textContent = dataSource;
        document.getElementById('last-refresh').textContent = lastRefreshTime.toLocaleTimeString();
        document.getElementById('record-count').textContent =
          allLeads.length + ' leads, ' + allCallReports.length + ' calls, ' + allCallbacks.length + ' callbacks';

        // Update tab counts
        document.getElementById('count-leads').textContent = allLeads.length;
        document.getElementById('count-outbound').textContent = allLeads.filter(function(l) { return l.phone; }).length;
        document.getElementById('count-reports').textContent = allCallReports.length;
        document.getElementById('count-callbacks').textContent = allCallbacks.length;
      }

      function setAPIStatus(status, text) {
        var dot = document.getElementById('api-status-dot');
        var label = document.getElementById('api-status-text');
        dot.className = 'status-dot';
        if (status === 'connected') {
          dot.classList.add('green');
        } else if (status === 'offline') {
          dot.classList.add('red');
        } else if (status === 'loading') {
          dot.classList.add('blue', 'pulsing');
        } else {
          dot.classList.add('orange');
        }
        label.textContent = text;
      }

      // ─── Render Stats Bar ───
      function renderStats() {
        var leads = allLeads;
        var today = new Date().toISOString().split('T')[0];
        var todayLeads = leads.filter(function(l) {
          return l.timestamp && l.timestamp.split('T')[0] === today;
        });

        var products = {};
        leads.forEach(function(l) {
          var p = l.product || 'Unknown';
          products[p] = (products[p] || 0) + 1;
        });
        var topProduct = Object.keys(products).sort(function(a,b) { return products[b] - products[a]; })[0] || 'N/A';

        var withPhone = leads.filter(function(l) { return l.phone; }).length;
        var outboundCalls = leads.filter(function(l) { return l.outboundCallStatus === 'initiated'; }).length;
        var totalCalls = allCallReports.length;

        // Compute total call duration
        var totalDuration = 0;
        allCallReports.forEach(function(r) {
          if (r.duration) totalDuration += parseInt(r.duration) || 0;
        });
        var durationStr = totalDuration >= 60
          ? Math.floor(totalDuration / 60) + 'm ' + (totalDuration % 60) + 's'
          : totalDuration + 's';

        // Count today's calls
        var todayCalls = allCallReports.filter(function(r) {
          return r.timestamp && r.timestamp.split('T')[0] === today;
        });

        // Inbound vs outbound
        var inboundCalls = allCallReports.filter(function(r) {
          return r.type === 'inboundPhoneCall';
        }).length;
        var outboundCallReports = allCallReports.filter(function(r) {
          return r.type === 'outboundPhoneCall';
        }).length;

        document.getElementById('stats-bar').innerHTML =
          '<div class="stat-card"><div class="label">Total Leads</div><div class="value blue">' + leads.length + '</div></div>' +
          '<div class="stat-card"><div class="label">Today\'s Leads</div><div class="value green">' + todayLeads.length + '</div></div>' +
          '<div class="stat-card"><div class="label">Total Calls</div><div class="value orange">' + totalCalls + '</div></div>' +
          '<div class="stat-card"><div class="label">Today\'s Calls</div><div class="value green">' + todayCalls.length + '</div></div>' +
          '<div class="stat-card"><div class="label">Inbound / Outbound</div><div class="value" style="font-size:20px">' + inboundCalls + ' / ' + outboundCallReports + '</div></div>' +
          '<div class="stat-card"><div class="label">Total Duration</div><div class="value blue">' + durationStr + '</div></div>' +
          '<div class="stat-card"><div class="label">Top Product</div><div class="value" style="font-size:16px">' + esc(topProduct) + '</div></div>';
      }

      // ─── Render Leads Table ───
      function renderLeads() {
        var leads = allLeads;
        var tbody = document.getElementById('leads-body');

        if (leads.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="empty">No leads captured yet. Leads from the sales agent will appear here.</td></tr>';
          return;
        }

        var sorted = leads.slice().sort(function(a,b) {
          return (b.timestamp || '').localeCompare(a.timestamp || '');
        });
        tbody.innerHTML = sorted.map(function(lead, i) {
          var date = lead.timestamp ? new Date(lead.timestamp).toLocaleString() : 'N/A';
          var productClass = 'blue';
          if (lead.product && lead.product.indexOf('AIREC') !== -1) productClass = 'green';
          if (lead.product && lead.product.indexOf('General') !== -1) productClass = 'orange';
          if (lead.product && lead.product.indexOf('WorkBench') !== -1) productClass = 'green';

          var callBadge = '';
          if (lead.outboundCallStatus === 'initiated') {
            callBadge = '<span class="badge badge-green">Called</span>';
          } else if (lead.outboundCallStatus === 'failed') {
            callBadge = '<span class="badge badge-red">Failed</span>';
          } else if (lead.phone) {
            callBadge = '<span class="badge badge-dim">Pending</span>';
          } else {
            callBadge = '<span style="color:var(--dim)">—</span>';
          }

          var sourceBadge = '<span class="badge badge-dim">' + esc(lead.source || 'website') + '</span>';

          return '<tr>' +
            '<td>' + (i + 1) + '</td>' +
            '<td><strong>' + esc(lead.name || '') + '</strong></td>' +
            '<td>' + esc(lead.email || '') + '</td>' +
            '<td>' + (lead.phone ? '<a href="tel:' + esc(lead.phone) + '">' + esc(lead.phone) + '</a>' : '<span style="color:var(--dim)">—</span>') + '</td>' +
            '<td><span class="badge badge-' + productClass + '">' + esc(lead.product || 'N/A') + '</span></td>' +
            '<td>' + sourceBadge + '</td>' +
            '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + esc(lead.need || '—') + '</td>' +
            '<td>' + callBadge + '</td>' +
            '<td style="white-space:nowrap">' + date + '</td>' +
          '</tr>';
        }).join('');
      }

      // ─── Render Outbound Calls ───
      function renderOutbound() {
        var leads = allLeads.filter(function(l) { return l.phone; });
        var tbody = document.getElementById('outbound-body');

        if (leads.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">No leads with phone numbers yet.</td></tr>';
          return;
        }

        var sorted = leads.slice().sort(function(a,b) {
          return (b.timestamp || '').localeCompare(a.timestamp || '');
        });
        tbody.innerHTML = sorted.map(function(lead) {
          var date = lead.timestamp ? new Date(lead.timestamp).toLocaleString() : 'N/A';

          var statusBadge = '';
          if (lead.outboundCallStatus === 'initiated') {
            statusBadge = '<span class="badge badge-green">Initiated</span>';
          } else if (lead.outboundCallStatus === 'failed') {
            statusBadge = '<span class="badge badge-red">Failed</span>';
          } else {
            statusBadge = '<span class="badge badge-dim">Not triggered</span>';
          }

          return '<tr>' +
            '<td><strong>' + esc(lead.name || '') + '</strong></td>' +
            '<td><a href="tel:' + esc(lead.phone) + '">' + esc(lead.phone) + '</a></td>' +
            '<td>' + esc(lead.product || 'N/A') + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td style="font-family:monospace;font-size:11px;color:var(--dim)">' + esc(lead.outboundCallId || '—') + '</td>' +
            '<td style="white-space:nowrap">' + date + '</td>' +
          '</tr>';
        }).join('');
      }

      // ─── Render Call Reports ───
      function renderReports() {
        var reports = allCallReports;
        var tbody = document.getElementById('reports-body');

        if (reports.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="empty">No call reports yet. Reports appear after Vapi AI calls complete.</td></tr>';
          return;
        }

        var sorted = reports.slice().sort(function(a,b) {
          return (b.timestamp || '').localeCompare(a.timestamp || '');
        });
        tbody.innerHTML = sorted.map(function(r) {
          var date = r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A';
          var typeBadge = r.type === 'outboundPhoneCall'
            ? '<span class="badge badge-orange">Outbound</span>'
            : '<span class="badge badge-blue">Inbound</span>';
          var duration = r.duration ? r.duration + 's' : '—';
          var cost = r.cost ? '$' + parseFloat(r.cost).toFixed(4) : '—';
          var endedClass = r.endedReason === 'customer-ended-call' ? 'badge-green' : 'badge-dim';
          var summary = r.summary || '—';
          var summaryShort = summary.length > 60 ? summary.substring(0, 60) + '...' : summary;

          // Source indicator — from KV webhook or live Vapi API
          var sourceBadge = r._fromVapi
            ? '<span class="badge badge-green">Vapi API</span>'
            : '<span class="badge badge-dim">KV</span>';

          // Status badge for active/queued calls
          var statusInfo = '';
          if (r.status && r.status !== 'ended') {
            statusInfo = ' <span class="badge badge-orange">' + esc(r.status) + '</span>';
          }

          return '<tr>' +
            '<td>' + typeBadge + statusInfo + '</td>' +
            '<td>' + esc(r.customerNumber || '—') + '</td>' +
            '<td><strong>' + esc(duration) + '</strong></td>' +
            '<td>' + esc(cost) + '</td>' +
            '<td><span class="badge ' + endedClass + '">' + esc(r.endedReason || '—') + '</span></td>' +
            '<td class="report-summary" title="' + esc(summary) + '">' + esc(summaryShort) + '</td>' +
            '<td>' + sourceBadge + '</td>' +
            '<td style="font-family:monospace;font-size:11px;color:var(--dim)">' + esc(r.callId || '—').substring(0, 12) + '</td>' +
            '<td style="white-space:nowrap">' + date + '</td>' +
          '</tr>';
        }).join('');
      }

      // ─── Render Callbacks ───
      function renderCallbacks() {
        var callbacks = allCallbacks;
        var tbody = document.getElementById('callbacks-body');

        if (callbacks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No callbacks scheduled yet.</td></tr>';
          return;
        }

        var sorted = callbacks.slice().sort(function(a,b) {
          return (b.timestamp || '').localeCompare(a.timestamp || '');
        });
        tbody.innerHTML = sorted.map(function(cb) {
          var date = cb.timestamp ? new Date(cb.timestamp).toLocaleString() : 'N/A';
          return '<tr>' +
            '<td><strong>' + esc(cb.name || '') + '</strong></td>' +
            '<td><a href="tel:' + esc(cb.phone || '') + '">' + esc(cb.phone || '—') + '</a></td>' +
            '<td>' + esc(cb.preferredTime || '—') + '</td>' +
            '<td>' + esc(cb.reason || '—') + '</td>' +
            '<td style="white-space:nowrap">' + date + '</td>' +
          '</tr>';
        }).join('');
      }

      // ─── Render Analytics ───
      function renderAnalytics() {
        var leads = allLeads;

        // Product breakdown
        var products = {};
        leads.forEach(function(l) {
          var p = l.product || 'Unknown';
          products[p] = (products[p] || 0) + 1;
        });

        var productHTML = '<table class="data-table"><thead><tr><th>Product</th><th>Leads</th><th>% of Total</th></tr></thead><tbody>';
        Object.keys(products).sort(function(a,b) { return products[b] - products[a]; }).forEach(function(p) {
          var pct = leads.length > 0 ? ((products[p] / leads.length) * 100).toFixed(1) : '0';
          productHTML += '<tr><td>' + esc(p) + '</td><td><strong>' + products[p] + '</strong></td><td>' + pct + '%</td></tr>';
        });
        productHTML += '</tbody></table>';
        if (leads.length === 0) productHTML = '<p style="color:var(--dim)">No data yet.</p>';
        document.getElementById('product-breakdown').innerHTML = productHTML;

        // Daily breakdown
        var days = {};
        leads.forEach(function(l) {
          var d = l.timestamp ? l.timestamp.split('T')[0] : 'Unknown';
          days[d] = (days[d] || 0) + 1;
        });

        var dayHTML = '<table class="data-table"><thead><tr><th>Date</th><th>Leads</th></tr></thead><tbody>';
        Object.keys(days).sort().reverse().forEach(function(d) {
          dayHTML += '<tr><td>' + d + '</td><td><strong>' + days[d] + '</strong></td></tr>';
        });
        dayHTML += '</tbody></table>';
        if (leads.length === 0) dayHTML = '<p style="color:var(--dim)">No data yet.</p>';
        document.getElementById('daily-breakdown').innerHTML = dayHTML;

        // Source breakdown
        var sources = {};
        leads.forEach(function(l) {
          var s = l.source || 'website';
          sources[s] = (sources[s] || 0) + 1;
        });

        var srcHTML = '<table class="data-table"><thead><tr><th>Source</th><th>Leads</th><th>% of Total</th></tr></thead><tbody>';
        Object.keys(sources).sort(function(a,b) { return sources[b] - sources[a]; }).forEach(function(s) {
          var pct = leads.length > 0 ? ((sources[s] / leads.length) * 100).toFixed(1) : '0';
          srcHTML += '<tr><td>' + esc(s) + '</td><td><strong>' + sources[s] + '</strong></td><td>' + pct + '%</td></tr>';
        });
        srcHTML += '</tbody></table>';
        if (leads.length === 0) srcHTML = '<p style="color:var(--dim)">No data yet.</p>';
        document.getElementById('source-breakdown').innerHTML = srcHTML;
      }

      // ─── Render Activity Log ───
      function renderLog() {
        var logEl = document.getElementById('activity-log');
        var entries = [];

        // Leads
        allLeads.forEach(function(lead) {
          var ts = lead.timestamp ? new Date(lead.timestamp).toLocaleString() : 'unknown time';
          entries.push({
            time: lead.timestamp || '',
            html: '<div class="log-entry">' +
              '<span class="timestamp">[' + ts + ']</span>' +
              '<span class="event">LEAD_CAPTURED</span> ' +
              '<span class="data">' + esc(lead.name) + ' &lt;' + esc(lead.email) + '&gt; — ' + esc(lead.product || 'N/A') + ' [' + esc(lead.source || 'web') + ']</span>' +
            '</div>'
          });
          if (lead.outboundCallStatus === 'initiated') {
            entries.push({
              time: lead.timestamp || '',
              html: '<div class="log-entry">' +
                '<span class="timestamp">[' + ts + ']</span>' +
                '<span class="event-call">OUTBOUND_CALL</span> ' +
                '<span class="data">Called ' + esc(lead.phone) + ' — Call ID: ' + esc(lead.outboundCallId || 'N/A') + '</span>' +
              '</div>'
            });
          } else if (lead.outboundCallStatus === 'failed') {
            entries.push({
              time: lead.timestamp || '',
              html: '<div class="log-entry">' +
                '<span class="timestamp">[' + ts + ']</span>' +
                '<span class="event-call" style="color:var(--red)">CALL_FAILED</span> ' +
                '<span class="data">' + esc(lead.phone) + ' — ' + esc(lead.outboundCallError || 'Unknown error') + '</span>' +
              '</div>'
            });
          }
        });

        // Call reports
        allCallReports.forEach(function(r) {
          var ts = r.timestamp ? new Date(r.timestamp).toLocaleString() : 'unknown time';
          var callType = r.type === 'outboundPhoneCall' ? 'OUTBOUND' : 'INBOUND';
          var src = r._fromVapi ? ' [Vapi API]' : ' [KV]';
          entries.push({
            time: r.timestamp || '',
            html: '<div class="log-entry">' +
              '<span class="timestamp">[' + ts + ']</span>' +
              '<span class="event-report">CALL_REPORT</span> ' +
              '<span class="data">' + callType + ' ' + esc(r.customerNumber || 'unknown') + ' — ' + (r.duration || 0) + 's — ' + esc(r.endedReason || r.status || 'unknown') + src + '</span>' +
            '</div>'
          });
        });

        // Callbacks
        allCallbacks.forEach(function(cb) {
          var ts = cb.timestamp ? new Date(cb.timestamp).toLocaleString() : 'unknown time';
          entries.push({
            time: cb.timestamp || '',
            html: '<div class="log-entry">' +
              '<span class="timestamp">[' + ts + ']</span>' +
              '<span class="event-callback">CALLBACK_SCHEDULED</span> ' +
              '<span class="data">' + esc(cb.name) + ' ' + esc(cb.phone) + ' — ' + esc(cb.preferredTime || 'N/A') + '</span>' +
            '</div>'
          });
        });

        if (entries.length === 0) {
          logEl.innerHTML = '<div class="log-entry" style="color:var(--dim)">No activity recorded yet.</div>';
          return;
        }

        // Sort all entries by time descending
        entries.sort(function(a, b) { return (b.time || '').localeCompare(a.time || ''); });
        logEl.innerHTML = entries.map(function(e) { return e.html; }).join('');
      }

      // ─── Render Diagnostics ───
      async function renderDiagnostics() {
        var container = document.getElementById('diagnostics-content');
        container.innerHTML = '<p style="color:var(--dim)">Running diagnostics...</p>';

        var diag = null;
        try {
          var res = await fetch(GTM_WORKER_URL + '/diagnostics', { headers: AUTH_HEADERS });
          if (res.ok) {
            diag = await res.json();
          } else if (res.status === 404) {
            diag = { status: 'not_deployed', message: 'Diagnostics endpoint not deployed yet. Deploy the updated GTM worker to enable.' };
          } else {
            diag = { status: 'error', message: 'HTTP ' + res.status };
          }
        } catch(e) {
          diag = { status: 'error', message: 'Network error: ' + e.message };
        }

        if (diag.status === 'not_deployed') {
          // Render a helpful fallback using local data
          container.innerHTML =
            '<div class="diag-grid">' +
              '<div class="diag-card">' +
                '<h4>Worker Status</h4>' +
                '<div class="diag-row"><span class="diag-label">Diagnostics endpoint</span><span class="diag-value warn">Not deployed</span></div>' +
                '<div class="diag-row"><span class="diag-label">Note</span><span class="diag-value" style="font-size:11px;white-space:normal">Deploy the updated gtm-outbound.js worker to enable full diagnostics</span></div>' +
              '</div>' +
              '<div class="diag-card">' +
                '<h4>Local Data</h4>' +
                '<div class="diag-row"><span class="diag-label">Leads in memory</span><span class="diag-value ok">' + allLeads.length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">Call reports in memory</span><span class="diag-value ok">' + allCallReports.length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">Callbacks in memory</span><span class="diag-value ok">' + allCallbacks.length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">localStorage leads</span><span class="diag-value">' + getLocalLeads().length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">Data source</span><span class="diag-value">' + esc(dataSource) + '</span></div>' +
              '</div>' +
            '</div>';
          return;
        }

        if (diag.status === 'error') {
          container.innerHTML =
            '<div class="diag-grid">' +
              '<div class="diag-card">' +
                '<h4>Worker Status</h4>' +
                '<div class="diag-row"><span class="diag-label">Status</span><span class="diag-value error">Error</span></div>' +
                '<div class="diag-row"><span class="diag-label">Detail</span><span class="diag-value" style="white-space:normal">' + esc(diag.message) + '</span></div>' +
              '</div>' +
              '<div class="diag-card">' +
                '<h4>Local Data</h4>' +
                '<div class="diag-row"><span class="diag-label">Leads in memory</span><span class="diag-value">' + allLeads.length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">localStorage leads</span><span class="diag-value">' + getLocalLeads().length + '</span></div>' +
                '<div class="diag-row"><span class="diag-label">Data source</span><span class="diag-value">' + esc(dataSource) + '</span></div>' +
              '</div>' +
            '</div>';
          return;
        }

        // Full diagnostics from worker
        var c = diag.counts || {};
        var ts = diag.latestTimestamps || {};
        var kvBound = diag.kvBound ? 'Yes' : 'No';
        var kvBoundClass = diag.kvBound ? 'ok' : 'error';

        var html = '<div class="diag-grid">';

        // Worker health card
        html += '<div class="diag-card">' +
          '<h4>Worker Health</h4>' +
          '<div class="diag-row"><span class="diag-label">Status</span><span class="diag-value ok">' + esc(diag.status) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">KV Bound</span><span class="diag-value ' + kvBoundClass + '">' + kvBound + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Server Time</span><span class="diag-value">' + (diag.serverTime ? new Date(diag.serverTime).toLocaleString() : '—') + '</span></div>' +
        '</div>';

        // KV counts card
        html += '<div class="diag-card">' +
          '<h4>KV Record Counts</h4>' +
          '<div class="diag-row"><span class="diag-label">Leads (all_leads)</span><span class="diag-value ' + (c.leads > 0 ? 'ok' : 'warn') + '">' + (c.leads || 0) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Call Reports (call_reports)</span><span class="diag-value ' + (c.callReports > 0 ? 'ok' : 'warn') + '">' + (c.callReports || 0) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Callbacks (callbacks)</span><span class="diag-value">' + (c.callbacks || 0) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Total KV Keys</span><span class="diag-value">' + (c.kvKeys || 0) + '</span></div>' +
        '</div>';

        // Timestamps card
        html += '<div class="diag-card">' +
          '<h4>Latest Activity</h4>' +
          '<div class="diag-row"><span class="diag-label">Latest Lead</span><span class="diag-value">' + (ts.lead ? new Date(ts.lead).toLocaleString() : 'None') + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Latest Call Report</span><span class="diag-value">' + (ts.callReport ? new Date(ts.callReport).toLocaleString() : 'None') + '</span></div>' +
        '</div>';

        // Dashboard vs API card
        html += '<div class="diag-card">' +
          '<h4>Dashboard State</h4>' +
          '<div class="diag-row"><span class="diag-label">Leads in dashboard</span><span class="diag-value">' + allLeads.length + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Leads in KV</span><span class="diag-value">' + (c.leads || 0) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Leads in localStorage</span><span class="diag-value">' + getLocalLeads().length + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Data source</span><span class="diag-value">' + esc(dataSource) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Last refresh</span><span class="diag-value">' + (lastRefreshTime ? lastRefreshTime.toLocaleString() : '—') + '</span></div>' +
        '</div>';

        // Vapi API card
        html += '<div class="diag-card">' +
          '<h4>Vapi API (Live)</h4>' +
          '<div class="diag-row"><span class="diag-label">Calls from Vapi API</span><span class="diag-value ' + (allVapiCalls.length > 0 ? 'ok' : 'warn') + '">' + allVapiCalls.length + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Calls from KV</span><span class="diag-value">' + (c.callReports || 0) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Merged total</span><span class="diag-value ok">' + allCallReports.length + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">KV-only (missing from Vapi)</span><span class="diag-value">' + Math.max(0, (c.callReports || 0) - allVapiCalls.length) + '</span></div>' +
          '<div class="diag-row"><span class="diag-label">Vapi-only (missing from KV)</span><span class="diag-value ' + (allCallReports.filter(function(r){return r._fromVapi;}).length > 0 ? 'warn' : 'ok') + '">' + allCallReports.filter(function(r){return r._fromVapi;}).length + '</span></div>' +
        '</div>';

        html += '</div>';

        // KV keys list
        if (diag.kvKeys && diag.kvKeys.length > 0) {
          html += '<div class="diag-card" style="margin-top:20px">' +
            '<h4>KV Keys (' + diag.kvKeys.length + ')</h4>' +
            '<div class="kv-keys-list">' +
            diag.kvKeys.map(function(k) { return '<span class="key">' + esc(k) + '</span>'; }).join('<br>') +
            '</div></div>';
        }

        container.innerHTML = html;
      }

      // ─── Render Export ───
      function renderExport() {
        var allData = {
          leads: allLeads,
          callReports: allCallReports,
          callbacks: allCallbacks,
          exportedAt: new Date().toISOString()
        };
        document.getElementById('export-json').value = JSON.stringify(allData, null, 2);

        if (allLeads.length === 0) {
          document.getElementById('export-csv').value = 'No data to export.';
          return;
        }

        var headers = ['name', 'email', 'phone', 'product', 'need', 'source', 'outboundCallStatus', 'outboundCallId', 'page', 'timestamp'];
        var csv = headers.join(',') + '\n';
        allLeads.forEach(function(l) {
          csv += headers.map(function(h) {
            var val = (l[h] || '').toString().replace(/"/g, '""');
            return '"' + val + '"';
          }).join(',') + '\n';
        });
        document.getElementById('export-csv').value = csv;
      }

      // ─── Helpers ───
      function esc(str) {
        var el = document.createElement('span');
        el.textContent = str || '';
        return el.innerHTML;
      }

      // ─── Tab Switching ───
      document.querySelectorAll('.tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
          tab.classList.add('active');
          document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
          // Load diagnostics on demand
          if (tab.dataset.tab === 'diagnostics') {
            renderDiagnostics();
          }
        });
      });

      // ─── Auto-refresh ───
      function startAutoRefresh() {
        stopAutoRefresh();
        autoRefreshTimer = setInterval(function() {
          refreshData();
        }, 30000);
      }

      function stopAutoRefresh() {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }

      document.getElementById('auto-refresh-check').addEventListener('change', function() {
        if (this.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      // ─── Global Functions ───
      window.refreshData = async function() {
        setAPIStatus('loading', 'Refreshing...');
        await loadAllData();
        renderStats();
        renderLeads();
        renderOutbound();
        renderReports();
        renderCallbacks();
        renderAnalytics();
        renderLog();
        renderExport();
      };

      window.exportCSV = function() {
        var csv = document.getElementById('export-csv').value;
        var blob = new Blob([csv], { type: 'text/csv' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'novai-leads-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
      };

      window.exportJSON = function() {
        var json = document.getElementById('export-json').value;
        var blob = new Blob([json], { type: 'application/json' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'novai-data-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
      };

      window.clearData = function() {
        if (confirm('Are you sure? This will delete leads from localStorage and KV. Call reports from Vapi API will remain visible.')) {
          localStorage.removeItem('novai_leads');
          fetch(GTM_WORKER_URL + '/leads', { method: 'DELETE', headers: AUTH_HEADERS }).catch(function(){});
          allLeads = [];
          // Keep Vapi API call reports (they can't be deleted from here)
          allCallReports = allCallReports.filter(function(r) { return r._fromVapi; });
          allCallbacks = [];
          renderStats();
          renderLeads();
          renderOutbound();
          renderReports();
          renderCallbacks();
          renderAnalytics();
          renderLog();
          renderExport();
        }
      };

      // ─── Init ───
      refreshData();
      startAutoRefresh();
    })();
  </script>
</body>
</html>
